---
kind: pipeline
name: default

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: clone
  image: autonomy/build-container:latest
  commands:
  - git config --global user.email talos@talos.dev
  - git config --global user.name talos
  - git init
  - git remote add origin ${DRONE_REMOTE_URL}
  - "git fetch origin +refs/heads/${DRONE_COMMIT_BRANCH}:"
  - git checkout ${DRONE_COMMIT_BRANCH}
  - "git fetch origin ${DRONE_COMMIT_REF}:"
  - git merge ${DRONE_COMMIT_SHA}
  - git fetch --tags
  when:
    event:
      exclude:
      - ""

- name: machined
  image: autonomy/build-container:latest
  commands:
  - make machined
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osd
  image: autonomy/build-container:latest
  commands:
  - make osd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: trustd
  image: autonomy/build-container:latest
  commands:
  - make trustd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: proxyd
  image: autonomy/build-container:latest
  commands:
  - make proxyd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: ntpd
  image: autonomy/build-container:latest
  commands:
  - make ntpd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osctl-linux
  image: autonomy/build-container:latest
  commands:
  - make osctl-linux
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osctl-darwin
  image: autonomy/build-container:latest
  commands:
  - make osctl-darwin
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: rootfs
  image: autonomy/build-container:latest
  commands:
  - make rootfs
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - machined
  - osd
  - trustd
  - proxyd
  - ntpd

- name: initramfs
  image: autonomy/build-container:latest
  commands:
  - make initramfs
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: installer
  image: autonomy/build-container:latest
  commands:
  - make installer
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: container
  image: autonomy/build-container:latest
  commands:
  - make container
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: lint
  image: autonomy/build-container:latest
  commands:
  - make lint
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: image-test
  image: autonomy/build-container:latest
  commands:
  - make image-test
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: unit-tests
  image: autonomy/build-container:latest
  commands:
  - make unit-tests
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: coverage
  image: plugins/codecov
  settings:
    files:
    - coverage.txt
    token:
      from_secret: codecov_token
  when:
    event:
    - pull_request
  depends_on:
  - unit-tests

- name: basic-integration
  image: autonomy/build-container:latest
  commands:
  - make basic-integration
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - container
  - osctl-linux

- name: push
  pull: always
  image: autonomy/build-container:latest
  commands:
  - make gitmeta
  - make login
  - make push
  environment:
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  when:
    event:
      include:
      - push
      exclude:
      - promote
  depends_on:
  - basic-integration

services:
- name: docker
  image: docker:19.03-dind
  entrypoint:
  - dockerd
  command:
  - --dns=8.8.8.8
  - --dns=8.8.4.4
  - --mtu=1440
  - --log-level=error
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp

volumes:
- name: dockersock
  temp: {}
- name: dev
  host:
    path: /dev
- name: tmp
  temp: {}

node:
  node-role.kubernetes.io/ci: ""

trigger:
  cron:
    exclude:
    - nightly
  event:
    exclude:
    - promote

---
kind: pipeline
name: e2e

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: clone
  image: autonomy/build-container:latest
  commands:
  - git config --global user.email talos@talos.dev
  - git config --global user.name talos
  - git init
  - git remote add origin ${DRONE_REMOTE_URL}
  - "git fetch origin +refs/heads/${DRONE_COMMIT_BRANCH}:"
  - git checkout ${DRONE_COMMIT_BRANCH}
  - "git fetch origin ${DRONE_COMMIT_REF}:"
  - git merge ${DRONE_COMMIT_SHA}
  - git fetch --tags
  when:
    event:
      exclude:
      - ""

- name: machined
  image: autonomy/build-container:latest
  commands:
  - make machined
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osd
  image: autonomy/build-container:latest
  commands:
  - make osd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: trustd
  image: autonomy/build-container:latest
  commands:
  - make trustd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: proxyd
  image: autonomy/build-container:latest
  commands:
  - make proxyd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: ntpd
  image: autonomy/build-container:latest
  commands:
  - make ntpd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osctl-linux
  image: autonomy/build-container:latest
  commands:
  - make osctl-linux
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osctl-darwin
  image: autonomy/build-container:latest
  commands:
  - make osctl-darwin
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: rootfs
  image: autonomy/build-container:latest
  commands:
  - make rootfs
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - machined
  - osd
  - trustd
  - proxyd
  - ntpd

- name: initramfs
  image: autonomy/build-container:latest
  commands:
  - make initramfs
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: installer
  image: autonomy/build-container:latest
  commands:
  - make installer
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: container
  image: autonomy/build-container:latest
  commands:
  - make container
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: lint
  image: autonomy/build-container:latest
  commands:
  - make lint
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: image-test
  image: autonomy/build-container:latest
  commands:
  - make image-test
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: unit-tests
  image: autonomy/build-container:latest
  commands:
  - make unit-tests
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: coverage
  image: plugins/codecov
  settings:
    files:
    - coverage.txt
    token:
      from_secret: codecov_token
  when:
    event:
    - pull_request
  depends_on:
  - unit-tests

- name: basic-integration
  image: autonomy/build-container:latest
  commands:
  - make basic-integration
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - container
  - osctl-linux

- name: push
  pull: always
  image: autonomy/build-container:latest
  commands:
  - make gitmeta
  - make login
  - make push
  environment:
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  when:
    event:
      include:
      - push
      exclude:
      - promote
  depends_on:
  - basic-integration

- name: capi
  image: autonomy/build-container:latest
  commands:
  - make capi
  environment:
    AZURE_SVC_ACCT:
      from_secret: azure_svc_acct
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    GCE_SVC_ACCT:
      from_secret: gce_svc_acct
    PACKET_AUTH_TOKEN:
      from_secret: packet_auth_token
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - basic-integration

- name: image-azure
  image: autonomy/build-container:latest
  commands:
  - make image-azure
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: image-gce
  image: autonomy/build-container:latest
  commands:
  - make image-gce
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: push-image-azure
  image: autonomy/build-container:latest
  commands:
  - make push-image-azure
  environment:
    AZURE_SVC_ACCT:
      from_secret: azure_svc_acct
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    GCE_SVC_ACCT:
      from_secret: gce_svc_acct
    PACKET_AUTH_TOKEN:
      from_secret: packet_auth_token
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - image-azure

- name: push-image-gce
  image: autonomy/build-container:latest
  commands:
  - make push-image-gce
  environment:
    AZURE_SVC_ACCT:
      from_secret: azure_svc_acct
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    GCE_SVC_ACCT:
      from_secret: gce_svc_acct
    PACKET_AUTH_TOKEN:
      from_secret: packet_auth_token
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - image-gce

- name: e2e-integration-azure
  image: autonomy/build-container:latest
  commands:
  - make e2e-integration
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    PLATFORM: azure
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - capi
  - push-image-azure

- name: e2e-integration-gce
  image: autonomy/build-container:latest
  commands:
  - make e2e-integration
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    PLATFORM: gce
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - capi
  - push-image-gce

services:
- name: docker
  image: docker:19.03-dind
  entrypoint:
  - dockerd
  command:
  - --dns=8.8.8.8
  - --dns=8.8.4.4
  - --mtu=1440
  - --log-level=error
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp

volumes:
- name: dockersock
  temp: {}
- name: dev
  host:
    path: /dev
- name: tmp
  temp: {}

node:
  node-role.kubernetes.io/ci: ""

trigger:
  target:
  - e2e

---
kind: pipeline
name: conformance

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: clone
  image: autonomy/build-container:latest
  commands:
  - git config --global user.email talos@talos.dev
  - git config --global user.name talos
  - git init
  - git remote add origin ${DRONE_REMOTE_URL}
  - "git fetch origin +refs/heads/${DRONE_COMMIT_BRANCH}:"
  - git checkout ${DRONE_COMMIT_BRANCH}
  - "git fetch origin ${DRONE_COMMIT_REF}:"
  - git merge ${DRONE_COMMIT_SHA}
  - git fetch --tags
  when:
    event:
      exclude:
      - ""

- name: machined
  image: autonomy/build-container:latest
  commands:
  - make machined
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osd
  image: autonomy/build-container:latest
  commands:
  - make osd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: trustd
  image: autonomy/build-container:latest
  commands:
  - make trustd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: proxyd
  image: autonomy/build-container:latest
  commands:
  - make proxyd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: ntpd
  image: autonomy/build-container:latest
  commands:
  - make ntpd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osctl-linux
  image: autonomy/build-container:latest
  commands:
  - make osctl-linux
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osctl-darwin
  image: autonomy/build-container:latest
  commands:
  - make osctl-darwin
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: rootfs
  image: autonomy/build-container:latest
  commands:
  - make rootfs
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - machined
  - osd
  - trustd
  - proxyd
  - ntpd

- name: initramfs
  image: autonomy/build-container:latest
  commands:
  - make initramfs
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: installer
  image: autonomy/build-container:latest
  commands:
  - make installer
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: container
  image: autonomy/build-container:latest
  commands:
  - make container
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: lint
  image: autonomy/build-container:latest
  commands:
  - make lint
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: image-test
  image: autonomy/build-container:latest
  commands:
  - make image-test
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: unit-tests
  image: autonomy/build-container:latest
  commands:
  - make unit-tests
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: coverage
  image: plugins/codecov
  settings:
    files:
    - coverage.txt
    token:
      from_secret: codecov_token
  when:
    event:
    - pull_request
  depends_on:
  - unit-tests

- name: basic-integration
  image: autonomy/build-container:latest
  commands:
  - make basic-integration
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - container
  - osctl-linux

- name: push
  pull: always
  image: autonomy/build-container:latest
  commands:
  - make gitmeta
  - make login
  - make push
  environment:
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  when:
    event:
      include:
      - push
      exclude:
      - promote
  depends_on:
  - basic-integration

- name: capi
  image: autonomy/build-container:latest
  commands:
  - make capi
  environment:
    AZURE_SVC_ACCT:
      from_secret: azure_svc_acct
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    GCE_SVC_ACCT:
      from_secret: gce_svc_acct
    PACKET_AUTH_TOKEN:
      from_secret: packet_auth_token
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - basic-integration

- name: image-azure
  image: autonomy/build-container:latest
  commands:
  - make image-azure
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: image-gce
  image: autonomy/build-container:latest
  commands:
  - make image-gce
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: push-image-azure
  image: autonomy/build-container:latest
  commands:
  - make push-image-azure
  environment:
    AZURE_SVC_ACCT:
      from_secret: azure_svc_acct
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    GCE_SVC_ACCT:
      from_secret: gce_svc_acct
    PACKET_AUTH_TOKEN:
      from_secret: packet_auth_token
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - image-azure

- name: push-image-gce
  image: autonomy/build-container:latest
  commands:
  - make push-image-gce
  environment:
    AZURE_SVC_ACCT:
      from_secret: azure_svc_acct
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    GCE_SVC_ACCT:
      from_secret: gce_svc_acct
    PACKET_AUTH_TOKEN:
      from_secret: packet_auth_token
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - image-gce

- name: conformance-azure
  image: autonomy/build-container:latest
  commands:
  - make e2e-integration
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    CONFORMANCE: run
    PLATFORM: azure
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - capi
  - push-image-azure

- name: conformance-gce
  image: autonomy/build-container:latest
  commands:
  - make e2e-integration
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    CONFORMANCE: run
    PLATFORM: gce
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - capi
  - push-image-gce

services:
- name: docker
  image: docker:19.03-dind
  entrypoint:
  - dockerd
  command:
  - --dns=8.8.8.8
  - --dns=8.8.4.4
  - --mtu=1440
  - --log-level=error
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp

volumes:
- name: dockersock
  temp: {}
- name: dev
  host:
    path: /dev
- name: tmp
  temp: {}

node:
  node-role.kubernetes.io/ci: ""

trigger:
  target:
  - conformance

---
kind: pipeline
name: nightly

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: clone
  image: autonomy/build-container:latest
  commands:
  - git config --global user.email talos@talos.dev
  - git config --global user.name talos
  - git init
  - git remote add origin ${DRONE_REMOTE_URL}
  - "git fetch origin +refs/heads/${DRONE_COMMIT_BRANCH}:"
  - git checkout ${DRONE_COMMIT_BRANCH}
  - "git fetch origin ${DRONE_COMMIT_REF}:"
  - git merge ${DRONE_COMMIT_SHA}
  - git fetch --tags
  when:
    event:
      exclude:
      - ""

- name: machined
  image: autonomy/build-container:latest
  commands:
  - make machined
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osd
  image: autonomy/build-container:latest
  commands:
  - make osd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: trustd
  image: autonomy/build-container:latest
  commands:
  - make trustd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: proxyd
  image: autonomy/build-container:latest
  commands:
  - make proxyd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: ntpd
  image: autonomy/build-container:latest
  commands:
  - make ntpd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osctl-linux
  image: autonomy/build-container:latest
  commands:
  - make osctl-linux
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osctl-darwin
  image: autonomy/build-container:latest
  commands:
  - make osctl-darwin
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: rootfs
  image: autonomy/build-container:latest
  commands:
  - make rootfs
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - machined
  - osd
  - trustd
  - proxyd
  - ntpd

- name: initramfs
  image: autonomy/build-container:latest
  commands:
  - make initramfs
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: installer
  image: autonomy/build-container:latest
  commands:
  - make installer
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: container
  image: autonomy/build-container:latest
  commands:
  - make container
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: lint
  image: autonomy/build-container:latest
  commands:
  - make lint
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: image-test
  image: autonomy/build-container:latest
  commands:
  - make image-test
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: unit-tests
  image: autonomy/build-container:latest
  commands:
  - make unit-tests
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: coverage
  image: plugins/codecov
  settings:
    files:
    - coverage.txt
    token:
      from_secret: codecov_token
  when:
    event:
    - pull_request
  depends_on:
  - unit-tests

- name: basic-integration
  image: autonomy/build-container:latest
  commands:
  - make basic-integration
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - container
  - osctl-linux

- name: push
  pull: always
  image: autonomy/build-container:latest
  commands:
  - make gitmeta
  - make login
  - make push
  environment:
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  when:
    event:
      include:
      - push
      exclude:
      - promote
  depends_on:
  - basic-integration

- name: capi
  image: autonomy/build-container:latest
  commands:
  - make capi
  environment:
    AZURE_SVC_ACCT:
      from_secret: azure_svc_acct
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    GCE_SVC_ACCT:
      from_secret: gce_svc_acct
    PACKET_AUTH_TOKEN:
      from_secret: packet_auth_token
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - basic-integration

- name: image-azure
  image: autonomy/build-container:latest
  commands:
  - make image-azure
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: image-gce
  image: autonomy/build-container:latest
  commands:
  - make image-gce
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: push-image-azure
  image: autonomy/build-container:latest
  commands:
  - make push-image-azure
  environment:
    AZURE_SVC_ACCT:
      from_secret: azure_svc_acct
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    GCE_SVC_ACCT:
      from_secret: gce_svc_acct
    PACKET_AUTH_TOKEN:
      from_secret: packet_auth_token
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - image-azure

- name: push-image-gce
  image: autonomy/build-container:latest
  commands:
  - make push-image-gce
  environment:
    AZURE_SVC_ACCT:
      from_secret: azure_svc_acct
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    GCE_SVC_ACCT:
      from_secret: gce_svc_acct
    PACKET_AUTH_TOKEN:
      from_secret: packet_auth_token
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - image-gce

- name: conformance-azure
  image: autonomy/build-container:latest
  commands:
  - make e2e-integration
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    CONFORMANCE: run
    PLATFORM: azure
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - capi
  - push-image-azure

- name: conformance-gce
  image: autonomy/build-container:latest
  commands:
  - make e2e-integration
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
    CONFORMANCE: run
    PLATFORM: gce
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - capi
  - push-image-gce

services:
- name: docker
  image: docker:19.03-dind
  entrypoint:
  - dockerd
  command:
  - --dns=8.8.8.8
  - --dns=8.8.4.4
  - --mtu=1440
  - --log-level=error
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp

volumes:
- name: dockersock
  temp: {}
- name: dev
  host:
    path: /dev
- name: tmp
  temp: {}

node:
  node-role.kubernetes.io/ci: ""

trigger:
  cron:
  - nightly

---
kind: pipeline
name: release

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: clone
  image: autonomy/build-container:latest
  commands:
  - git config --global user.email talos@talos.dev
  - git config --global user.name talos
  - git init
  - git remote add origin ${DRONE_REMOTE_URL}
  - "git fetch origin +refs/heads/${DRONE_COMMIT_BRANCH}:"
  - git checkout ${DRONE_COMMIT_BRANCH}
  - "git fetch origin ${DRONE_COMMIT_REF}:"
  - git merge ${DRONE_COMMIT_SHA}
  - git fetch --tags
  when:
    event:
      exclude:
      - ""

- name: machined
  image: autonomy/build-container:latest
  commands:
  - make machined
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osd
  image: autonomy/build-container:latest
  commands:
  - make osd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: trustd
  image: autonomy/build-container:latest
  commands:
  - make trustd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: proxyd
  image: autonomy/build-container:latest
  commands:
  - make proxyd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: ntpd
  image: autonomy/build-container:latest
  commands:
  - make ntpd
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osctl-linux
  image: autonomy/build-container:latest
  commands:
  - make osctl-linux
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: osctl-darwin
  image: autonomy/build-container:latest
  commands:
  - make osctl-darwin
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: rootfs
  image: autonomy/build-container:latest
  commands:
  - make rootfs
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - machined
  - osd
  - trustd
  - proxyd
  - ntpd

- name: initramfs
  image: autonomy/build-container:latest
  commands:
  - make initramfs
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: installer
  image: autonomy/build-container:latest
  commands:
  - make installer
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: container
  image: autonomy/build-container:latest
  commands:
  - make container
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: lint
  image: autonomy/build-container:latest
  commands:
  - make lint
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: image-test
  image: autonomy/build-container:latest
  commands:
  - make image-test
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: unit-tests
  image: autonomy/build-container:latest
  commands:
  - make unit-tests
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - rootfs

- name: coverage
  image: plugins/codecov
  settings:
    files:
    - coverage.txt
    token:
      from_secret: codecov_token
  when:
    event:
    - pull_request
  depends_on:
  - unit-tests

- name: basic-integration
  image: autonomy/build-container:latest
  commands:
  - make basic-integration
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - container
  - osctl-linux

- name: push
  pull: always
  image: autonomy/build-container:latest
  commands:
  - make gitmeta
  - make login
  - make push
  environment:
    DOCKER_PASSWORD:
      from_secret: docker_password
    DOCKER_USERNAME:
      from_secret: docker_username
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  when:
    event:
      include:
      - push
      exclude:
      - promote
  depends_on:
  - basic-integration

- name: kernel
  image: autonomy/build-container:latest
  commands:
  - make kernel
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - clone

- name: image-azure
  image: autonomy/build-container:latest
  commands:
  - make image-azure
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: image-gce
  image: autonomy/build-container:latest
  commands:
  - make image-gce
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: image-aws
  image: autonomy/build-container:latest
  commands:
  - make image-aws
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: aws_access_key_id
    AWS_DEFAULT_REGION: us-west-2
    AWS_PUBLISH_REGIONS: us-west-2,us-east-1,us-east-2,us-west-1,eu-central-1
    AWS_SECRET_ACCESS_KEY:
      from_secret: aws_secret_access_key
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  when:
    event:
    - tag
  depends_on:
  - push

- name: iso
  image: autonomy/build-container:latest
  commands:
  - make iso
  environment:
    BINDIR: /usr/local/bin
    BUILDKIT_HOST: ${BUILDKIT_HOST=tcp://buildkitd.ci.svc:1234}
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp
  depends_on:
  - installer

- name: release
  image: plugins/github-release
  settings:
    api_key:
      from_secret: github_token
    checksum:
    - sha256
    - sha512
    draft: true
    files:
    - build/*
  when:
    event:
    - tag
  depends_on:
  - kernel
  - iso
  - image-gce
  - image-azure
  - image-aws
  - push

services:
- name: docker
  image: docker:19.03-dind
  entrypoint:
  - dockerd
  command:
  - --dns=8.8.8.8
  - --dns=8.8.4.4
  - --mtu=1440
  - --log-level=error
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run
  - name: dev
    path: /dev
  - name: tmp
    path: /tmp

volumes:
- name: dockersock
  temp: {}
- name: dev
  host:
    path: /dev
- name: tmp
  temp: {}

node:
  node-role.kubernetes.io/ci: ""

trigger:
  event:
  - tag
  - promote
  target:
  - release

---
kind: pipeline
name: notify

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: slack
  image: plugins/slack
  settings:
    channel: proj-talos-maint
    webhook:
      from_secret: slack_webhook

services:
volumes:
- name: dockersock
  temp: {}
- name: dev
  host:
    path: /dev
- name: tmp
  temp: {}

node:
  node-role.kubernetes.io/ci: ""

trigger:
  status:
  - success
  - failure

depends_on:
- default
- e2e
- conformance
- nightly
- release

...
